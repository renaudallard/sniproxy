name: Release Packages

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to build packages from"
        required: true
        default: master
      release_tag:
        description: "Existing release tag to attach rebuilt assets to"
        required: true

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  RPMBUILD_TOPDIR: /tmp/rpmbuild

defaults:
  run:
    shell: bash

jobs:
  detect-versions:
    name: Detect distro versions
    runs-on: ubuntu-latest
    outputs:
      ubuntu_stable: ${{ steps.detect.outputs.ubuntu_stable }}
      ubuntu_lts: ${{ steps.detect.outputs.ubuntu_lts }}
      debian_stable: ${{ steps.detect.outputs.debian_stable }}
      debian_oldstable: ${{ steps.detect.outputs.debian_oldstable }}
      fedora_release: ${{ steps.detect.outputs.fedora_release }}
      rocky_release: ${{ steps.detect.outputs.rocky_release }}
    steps:
      - name: Fetch latest Ubuntu/Debian versions
        id: detect
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          import urllib.request
          import json

          def fetch_text(url):
              with urllib.request.urlopen(url, timeout=10) as resp:
                  return resp.read().decode()

          def latest_ubuntu_non_lts():
              try:
                  data = fetch_text("https://changelogs.ubuntu.com/meta-release")
                  versions = []
                  block = {}
                  for line in data.splitlines() + [""]:
                      if not line.strip():
                          if block.get("Supported") == "1" and block.get("Lts", "0") == "0" and "Version" in block:
                              versions.append(block["Version"])
                          block = {}
                          continue
                      if ":" in line:
                          k, v = line.split(":", 1)
                          block[k.strip()] = v.strip()
                  if versions:
                      return versions[-1]
              except Exception:
                  pass
              return "latest"

          def latest_ubuntu_lts():
              try:
                  data = fetch_text("https://changelogs.ubuntu.com/meta-release-lts")
                  versions = []
                  block = {}
                  for line in data.splitlines() + [""]:
                      if not line.strip():
                          if block.get("Supported") == "1" and block.get("Lts") == "1" and "Version" in block:
                              versions.append(block["Version"])
                          block = {}
                          continue
                      if ":" in line:
                          k, v = line.split(":", 1)
                          block[k.strip()] = v.strip()
                  if versions:
                      return versions[-1]
              except Exception:
                  pass
              return "22.04"

          def debian_codename(track):
              url = f"https://deb.debian.org/debian/dists/{track}/Release"
              try:
                  data = fetch_text(url)
                  for line in data.splitlines():
                      if line.startswith("Codename:"):
                          return line.split(":", 1)[1].strip()
              except Exception:
                  pass
              return track

          def latest_fedora_release():
              try:
                  data = fetch_text("https://getfedora.org/releases.json")
                  releases = json.loads(data)
                  versions = []
                  for entry in releases.get("fedora", []):
                      ver = entry.get("version")
                      status = entry.get("status")
                      edition = entry.get("edition")
                      if edition == "Everything" and status == "Active" and ver is not None:
                          versions.append(int(ver))
                  if versions:
                      return str(max(versions))
              except Exception:
                  pass
              return "39"

          def latest_rocky_release():
              try:
                  data = fetch_text("https://download.rockylinux.org/pub/rocky/metadata.json")
                  meta = json.loads(data)
                  versions = []
                  for rel in meta.get("releases", []):
                      if rel.get("released") is True:
                          versions.append(rel.get("version"))
                  if versions:
                      versions_sorted = sorted(versions, key=lambda v: [int(x) for x in v.split(".")])
                      return versions_sorted[-1]
              except Exception:
                  pass
              return "9"

          ubuntu_stable = latest_ubuntu_non_lts()
          ubuntu_lts = latest_ubuntu_lts()
          debian_stable = debian_codename("stable")
          debian_oldstable = debian_codename("oldstable")
          fedora_release = latest_fedora_release()
          rocky_release = latest_rocky_release()

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"ubuntu_stable={ubuntu_stable}\n")
              fh.write(f"ubuntu_lts={ubuntu_lts}\n")
              fh.write(f"debian_stable={debian_stable}\n")
              fh.write(f"debian_oldstable={debian_oldstable}\n")
              fh.write(f"fedora_release={fedora_release}\n")
              fh.write(f"rocky_release={rocky_release}\n")
          PY

  build-deb-ubuntu-stable:
    name: Build Debian Packages (Ubuntu Stable)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: ubuntu:${{ needs.detect-versions.outputs.ubuntu_stable }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates \
            build-essential devscripts debhelper \
            cdbs dh-autoreconf autotools-dev \
            autoconf automake libtool pkg-config \
            gettext libev-dev libpcre2-dev \
            libc-ares-dev libssl-dev libbsd-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Build Debian packages
        run: |
          set -euo pipefail
          dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect Debian artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/ubuntu-stable
          shopt -s nullglob
          for pkg in ../*.deb; do
            base=$(basename "$pkg")
            cp "$pkg" "artifacts/deb/ubuntu-stable/${base%.deb}-ubuntu-${{ needs.detect-versions.outputs.ubuntu_stable }}.deb"
          done

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-ubuntu-stable
          path: artifacts/deb/ubuntu-stable/
          if-no-files-found: error

  build-deb-ubuntu-lts:
    name: Build Debian Packages (Ubuntu LTS)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: ubuntu:${{ needs.detect-versions.outputs.ubuntu_lts }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates \
            build-essential devscripts debhelper \
            cdbs dh-autoreconf autotools-dev \
            autoconf automake libtool pkg-config \
            gettext libev-dev libpcre2-dev \
            libc-ares-dev libssl-dev libbsd-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Build Debian packages
        run: |
          set -euo pipefail
          dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect Debian artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/ubuntu-lts
          shopt -s nullglob
          for pkg in ../*.deb; do
            base=$(basename "$pkg")
            cp "$pkg" "artifacts/deb/ubuntu-lts/${base%.deb}-ubuntu-${{ needs.detect-versions.outputs.ubuntu_lts }}.deb"
          done

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-ubuntu-lts
          path: artifacts/deb/ubuntu-lts/
          if-no-files-found: error

  build-deb-debian-stable:
    name: Build Debian Packages (Debian Stable)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: debian:${{ needs.detect-versions.outputs.debian_stable }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates \
            build-essential devscripts debhelper \
            cdbs dh-autoreconf autotools-dev \
            autoconf automake libtool pkg-config \
            gettext libev-dev libpcre2-dev \
            libc-ares-dev libssl-dev libbsd-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Build Debian packages
        run: |
          set -euo pipefail
          dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect Debian artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/debian-stable
          shopt -s nullglob
          for pkg in ../*.deb; do
            base=$(basename "$pkg")
            cp "$pkg" "artifacts/deb/debian-stable/${base%.deb}-debian-${{ needs.detect-versions.outputs.debian_stable }}.deb"
          done

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-debian-stable
          path: artifacts/deb/debian-stable/
          if-no-files-found: error

  build-deb-debian-lts:
    name: Build Debian Packages (Debian LTS)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: debian:${{ needs.detect-versions.outputs.debian_oldstable }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates \
            build-essential devscripts debhelper \
            cdbs dh-autoreconf autotools-dev \
            autoconf automake libtool pkg-config \
            gettext libev-dev libpcre2-dev \
            libc-ares-dev libssl-dev libbsd-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Build Debian packages
        run: |
          set -euo pipefail
          dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect Debian artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/debian-lts
          shopt -s nullglob
          for pkg in ../*.deb; do
            base=$(basename "$pkg")
            cp "$pkg" "artifacts/deb/debian-lts/${base%.deb}-debian-${{ needs.detect-versions.outputs.debian_oldstable }}.deb"
          done

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-debian-lts
          path: artifacts/deb/debian-lts/
          if-no-files-found: error

  build-rpm:
    name: Build RPM Packages (${{ matrix.display_name }})
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    strategy:
      fail-fast: false
      matrix:
        include:
          - display_name: Fedora
            image: fedora:${{ needs.detect-versions.outputs.fedora_release }}
            artifact_suffix: fedora-${{ needs.detect-versions.outputs.fedora_release }}
          - display_name: Rocky Linux
            image: rockylinux:${{ needs.detect-versions.outputs.rocky_release }}
            artifact_suffix: rocky-${{ needs.detect-versions.outputs.rocky_release }}
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install required tooling
        run: |
          set -euo pipefail
          if grep -qi "rocky" /etc/os-release; then
            if command -v dnf >/dev/null 2>&1; then
              dnf install -y dnf-plugins-core epel-release
              dnf config-manager --set-enabled crb || true
              dnf install -y \
                git rpm-build make gcc gcc-c++ \
                autoconf automake libtool pkgconfig \
                gettext-devel libev-devel pcre2-devel \
                c-ares-devel openssl-devel libbsd-devel systemd-rpm-macros \
                which tar
            else
              yum install -y yum-utils epel-release
              yum config-manager --set-enabled crb || true
              yum install -y \
                git rpm-build make gcc gcc-c++ \
                autoconf automake libtool pkgconfig \
                gettext-devel libev-devel pcre2-devel \
                c-ares-devel openssl-devel libbsd-devel systemd-rpm-macros \
                which tar
            fi
          else
            dnf install -y \
              git rpm-build make gcc gcc-c++ \
              autoconf automake libtool pkgconfig \
              gettext-devel libev-devel pcre2-devel \
              c-ares-devel openssl-devel libbsd-devel systemd-rpm-macros \
              which tar
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          ./autogen.sh
          ./configure
          make dist
          DIST_TARBALL=$(ls -1t sniproxy-*.tar.gz | head -n1)
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${DIST_TARBALL}" "${RPM_TOPDIR}/SOURCES/"
          cp redhat/sniproxy.spec "${RPM_TOPDIR}/SPECS/"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          if ! rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/sniproxy.spec"; then
            echo "rpmbuild failed, dumping config.log files:" >&2
            find "${RPM_TOPDIR}/BUILD" -name config.log -print -exec cat {} \; || true
            exit 1
          fi

      - name: Collect RPM artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p "artifacts/rpm/${{ matrix.artifact_suffix }}"
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print -exec cp {} "artifacts/rpm/${{ matrix.artifact_suffix }}/" \;

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ matrix.artifact_suffix }}
          path: artifacts/rpm/${{ matrix.artifact_suffix }}/
          if-no-files-found: error

  publish:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs:
      - detect-versions
      - build-deb-ubuntu-stable
      - build-deb-ubuntu-lts
      - build-deb-debian-stable
      - build-deb-debian-lts
      - build-rpm
    steps:
      - name: Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-packages-*
          path: release-assets/deb
          merge-multiple: true

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rpm-packages-*
          path: release-assets/rpm
          merge-multiple: true

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || github.event.release.tag_name }}
          files: |
            release-assets/deb/*.deb
            release-assets/rpm/*.rpm
