name: Release Packages

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to build packages from"
        required: true
        default: master
      release_tag:
        description: "Existing release tag to attach rebuilt assets to"
        required: true

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  RPMBUILD_TOPDIR: /tmp/rpmbuild

jobs:
  build-deb:
    name: Build Debian Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Install build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential devscripts debhelper \
            cdbs dh-autoreconf autotools-dev \
            autoconf automake libtool pkg-config \
            gettext libev-dev libpcre2-dev \
            libc-ares-dev fakeroot dpkg-dev

      - name: Build Debian packages
        run: |
          set -euo pipefail
          dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect Debian artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb
          shopt -s nullglob
          for pkg in ../*.deb; do
            cp "$pkg" artifacts/deb/
          done

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages
          path: artifacts/deb/
          if-no-files-found: error

  build-rpm:
    name: Build RPM Packages
    runs-on: ubuntu-latest
    container:
      image: fedora:39
    steps:
      - name: Install required tooling
        run: |
          set -euo pipefail
          dnf install -y \
            git rpm-build make gcc gcc-c++ \
            autoconf automake libtool pkgconfig \
            gettext-devel libev-devel pcre2-devel \
            c-ares-devel openssl-devel systemd-rpm-macros \
            which tar

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          ./autogen.sh
          ./configure
          make dist
          DIST_TARBALL=$(ls -1t sniproxy-*.tar.gz | head -n1)
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${DIST_TARBALL}" "${RPM_TOPDIR}/SOURCES/"
          cp redhat/sniproxy.spec "${RPM_TOPDIR}/SPECS/"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          if ! rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/sniproxy.spec"; then
            echo "rpmbuild failed, dumping config.log files:" >&2
            find "${RPM_TOPDIR}/BUILD" -name config.log -print -exec cat {} \; || true
            exit 1
          fi

      - name: Collect RPM artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p artifacts/rpm
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print -exec cp {} artifacts/rpm/ \;

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: artifacts/rpm/
          if-no-files-found: error

  publish:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs:
      - build-deb
      - build-rpm
    steps:
      - name: Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          name: deb-packages
          path: release-assets/deb

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-packages
          path: release-assets/rpm

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || github.event.release.tag_name }}
          files: |
            release-assets/deb/*.deb
            release-assets/rpm/*.rpm
