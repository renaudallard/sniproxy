name: Sanitizers (ASAN/MSAN/UBSAN)

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  address-sanitizer:
    name: AddressSanitizer
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            libev-dev libpcre2-dev libc-ares-dev libssl-dev \
            libbsd-dev clang

      - name: Generate build system
        run: |
          set -euo pipefail
          AUTOCONF_VERSION=2.71 AUTOMAKE_VERSION=1.16 ./autogen.sh

      - name: Configure with AddressSanitizer
        env:
          CC: clang
        run: |
          set -euo pipefail
          ./configure --disable-dependency-tracking --enable-asan

      - name: Build
        run: make -j$(nproc)

      - name: Run tests with ASAN
        env:
          ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1:detect_stack_use_after_return=1:detect_invalid_pointer_pairs=2:strict_string_checks=1
          SKIP_BAD_REQUEST_TEST: 1
        run: |
          set -euo pipefail
          make check

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: asan-test-logs
          path: tests/*.log
          if-no-files-found: ignore

  memory-sanitizer:
    name: MemorySanitizer
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            clang cmake ninja-build python3

      - name: Cache MSAN instrumented libraries
        id: cache-msan-libs
        uses: actions/cache@v4
        with:
          path: ~/msan-libs
          key: msan-libs-${{ runner.os }}-clang-${{ hashFiles('.github/workflows/sanitizers.yml') }}-v3

      - name: Build instrumented libc++ and libc++abi
        if: steps.cache-msan-libs.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail

          # Create installation directory
          mkdir -p ~/msan-libs
          export MSAN_PREFIX=~/msan-libs

          # Clone LLVM project for libc++ sources
          cd /tmp
          git clone --depth=1 --branch=release/17.x https://github.com/llvm/llvm-project.git
          cd llvm-project

          # Build instrumented libc++ and libc++abi
          mkdir build-msan
          cd build-msan

          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi" \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_INSTALL_PREFIX="$MSAN_PREFIX" \
            -DLLVM_USE_SANITIZER=MemoryWithOrigins \
            -DCMAKE_C_FLAGS="-fsanitize=memory -fsanitize-memory-track-origins" \
            -DCMAKE_CXX_FLAGS="-fsanitize=memory -fsanitize-memory-track-origins" \
            ../llvm

          ninja cxx cxxabi
          ninja install-cxx install-cxxabi

          echo "✓ Instrumented libc++ built and installed to $MSAN_PREFIX"

      - name: Build instrumented libev
        if: steps.cache-msan-libs.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs

          cd /tmp
          git clone https://github.com/enki/libev.git
          cd libev
          git checkout v4.33

          ./autogen.sh

          CC=clang \
          CFLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer -g -O1" \
          LDFLAGS="-fsanitize=memory" \
          ./configure --prefix="$MSAN_PREFIX"

          make -j$(nproc)
          make install

          echo "✓ Instrumented libev built"

      - name: Build instrumented PCRE2
        if: steps.cache-msan-libs.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs

          cd /tmp
          wget https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.42/pcre2-10.42.tar.gz
          tar xzf pcre2-10.42.tar.gz
          cd pcre2-10.42

          CC=clang \
          CFLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer -g -O1" \
          LDFLAGS="-fsanitize=memory" \
          ./configure --prefix="$MSAN_PREFIX"

          make -j$(nproc)
          make install

          echo "✓ Instrumented PCRE2 built"

      - name: Build instrumented c-ares
        if: steps.cache-msan-libs.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs

          cd /tmp
          git clone https://github.com/c-ares/c-ares.git
          cd c-ares
          git checkout v1.33.1

          mkdir build
          cd build

          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_INSTALL_PREFIX="$MSAN_PREFIX" \
            -DCMAKE_C_FLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer -g -O1" \
            -DCMAKE_CXX_FLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer -g -O1" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=memory" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=memory" \
            ..

          ninja
          ninja install

          echo "✓ Instrumented c-ares built"

      - name: Build instrumented LibreSSL
        if: steps.cache-msan-libs.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs

          cd /tmp
          wget https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-4.2.1.tar.gz
          tar xzf libressl-4.2.1.tar.gz
          cd libressl-4.2.1

          CC=clang \
          CFLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer -g -O1" \
          LDFLAGS="-fsanitize=memory" \
          ./configure --prefix="$MSAN_PREFIX"

          make -j$(nproc)
          make install

          echo "✓ Instrumented LibreSSL built"

      - name: Build instrumented libbsd
        if: steps.cache-msan-libs.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs

          cd /tmp
          wget https://libbsd.freedesktop.org/releases/libbsd-0.11.7.tar.xz
          tar xf libbsd-0.11.7.tar.xz
          cd libbsd-0.11.7

          CC=clang \
          CFLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer -g -O1" \
          LDFLAGS="-fsanitize=memory" \
          ./configure --prefix="$MSAN_PREFIX"

          make -j$(nproc)
          make install

          echo "✓ Instrumented libbsd built"

          # Create summary
          echo "=== MSAN Instrumented Libraries Summary ==="
          ls -lh "$MSAN_PREFIX/lib" | head -20

      - name: Generate build system
        run: |
          set -euo pipefail
          AUTOCONF_VERSION=2.71 AUTOMAKE_VERSION=1.16 ./autogen.sh

      - name: Configure with MemorySanitizer
        env:
          CC: clang
          CXX: clang++
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs

          # Configure with MSAN using instrumented libraries
          # Note: --enable-msan sets the sanitizer flags, we just need to point to our libs
          export PKG_CONFIG_PATH="$MSAN_PREFIX/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          export CPPFLAGS="-I$MSAN_PREFIX/include"
          export LDFLAGS="-L$MSAN_PREFIX/lib -Wl,-rpath,$MSAN_PREFIX/lib -stdlib=libc++"

          ./configure --disable-dependency-tracking --enable-msan

      - name: Build
        run: |
          export MSAN_PREFIX=~/msan-libs
          export LD_LIBRARY_PATH="$MSAN_PREFIX/lib:${LD_LIBRARY_PATH:-}"
          make -j$(nproc)

      - name: Run tests with MSAN
        env:
          MSAN_OPTIONS: halt_on_error=1:print_stats=1:exitcode=1
          SKIP_BAD_REQUEST_TEST: 1
        run: |
          set -euo pipefail
          export MSAN_PREFIX=~/msan-libs
          export LD_LIBRARY_PATH="$MSAN_PREFIX/lib:${LD_LIBRARY_PATH:-}"
          make check

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: msan-test-logs
          path: tests/*.log
          if-no-files-found: ignore

  undefined-behavior-sanitizer:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            libev-dev libpcre2-dev libc-ares-dev libssl-dev \
            libbsd-dev clang

      - name: Generate build system
        run: |
          set -euo pipefail
          AUTOCONF_VERSION=2.71 AUTOMAKE_VERSION=1.16 ./autogen.sh

      - name: Configure with UBSan
        env:
          CC: clang
        run: |
          set -euo pipefail
          ./configure --disable-dependency-tracking --enable-ubsan

      - name: Build
        run: make -j$(nproc)

      - name: Run tests with UBSan
        env:
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
          SKIP_BAD_REQUEST_TEST: 1
        run: |
          set -euo pipefail
          make check

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ubsan-test-logs
          path: tests/*.log
          if-no-files-found: ignore

  combined-sanitizers:
    name: ASAN+UBSAN Combined
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            libev-dev libpcre2-dev libc-ares-dev libssl-dev \
            libbsd-dev clang

      - name: Generate build system
        run: |
          set -euo pipefail
          AUTOCONF_VERSION=2.71 AUTOMAKE_VERSION=1.16 ./autogen.sh

      - name: Configure with ASAN+UBSan
        env:
          CC: clang
        run: |
          set -euo pipefail
          ./configure --disable-dependency-tracking --enable-asan --enable-ubsan

      - name: Build
        run: make -j$(nproc)

      - name: Run tests with ASAN+UBSan
        env:
          ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1:detect_stack_use_after_return=1:detect_invalid_pointer_pairs=2:strict_string_checks=1
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
          SKIP_BAD_REQUEST_TEST: 1
        run: |
          set -euo pipefail
          make check

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: combined-sanitizer-test-logs
          path: tests/*.log
          if-no-files-found: ignore
